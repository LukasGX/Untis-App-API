<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Chat: {{ school }}</title>
		<style>
			body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; min-height: 100vh; padding: 20px; }
			.container { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px; max-width: 800px; margin: 0 auto; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
			h1 { font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; }
			.message { background: white; border-radius: 16px; padding: 20px; margin: 15px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 5px solid #10b981; }
			.message.deleted { opacity: 0.6; border-left-color: #6b7280; text-decoration: line-through; }
			.message.system { border-left-color: #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
			.message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
			.username { font-weight: 600; color: #1f2937; }
			.username.system { color: #d97706; font-weight: 700; }
			.timestamp { color: #6b7280; font-size: 14px; }
			.delete-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
			.delete-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(239,68,68,0.4); }
			.restore-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
			.restore-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(16,185,129,0.4); }
			.back-btn { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 12px 24px; border-radius: 12px; text-decoration: none; display: inline-block; margin-bottom: 20px; }
			.system-form { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 20px; margin: 20px 0; border-left: 5px solid #f59e0b; }
			.system-input { width: 100%; padding: 12px; border: 2px solid #fbbf24; border-radius: 12px; font-size: 16px; margin-bottom: 12px; box-sizing: border-box; }
			.system-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; }
			.system-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(245,158,11,0.4); }
			.template-btn { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; font-size: 14px; }
			.template-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(236,72,153,0.4); }
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Chat: {{ school }}</h1>
			<a href="/admin/dashboard" class="back-btn">← Dashboard</a>

			<!-- SANCTION BUTTON -->
			<button
				onclick="loadSanctionStatus()"
				style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; margin-bottom: 20px;">
				Chat sanktionieren
			</button>

			<!-- MODAL -->
			<div
				id="sanctionModal"
				style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
				<div
					style="background: white; margin: 10% auto; padding: 30px; border-radius: 16px; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
					<h3>Chat "{{ school }}" Status</h3>
					<div
						id="sanctionStatus"
						style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
						Lade Status...
					</div>
					<button
						id="freezeBtn"
						onclick="toggleFreeze()"
						style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; margin-right: 10px;">
						Chat einfrieren
					</button>
					<button
						onclick="closeSanctionModal()"
						style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer;">
						Schließen
					</button>
				</div>
			</div>

			<form
				action="/admin/chats/{{ school }}/system"
				method="POST"
				class="system-form">
				<input
					type="text"
					name="message"
					class="system-input"
					id="systemMessage"
					placeholder="System-Nachricht eingeben (max 200 Zeichen)..."
					maxlength="200"
					required />
				<div
					style="display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 10px;">
					<button
						type="button"
						class="template-btn warn"
						onclick="setTemplate('warn', 'Benutzername', true, 'Grund')">
						Verwarnung
					</button>
					<button
						type="button"
						class="template-btn ban"
						onclick="setTemplate('ban', 'Benutzername')">
						Ban
					</button>
					<button
						type="button"
						class="template-btn ban"
						onclick="setTemplate('unban', 'Benutzername')">
						Unban
					</button>
					<button
						type="button"
						class="template-btn ban"
						onclick="setTemplate('sanction', 'Eingefroren (j für Ja)')">
						Sanktion
					</button>
					<button type="submit" class="system-btn">Senden</button>
					<button
						type="button"
						class="system-btn"
						onclick="clearMessage()">
						Leeren
					</button>
				</div>
			</form>

			<div id="messages">
				{% for msg in messages %}
				<div
					class="message {% if msg['deleted'] %}deleted{% endif %} {% if msg['username'] == '[SYSTEM]' %}system{% endif %}">
					<div class="message-header">
						<div>
							<span
								class="username {% if msg['username'] == '[SYSTEM]' %}system{% endif %}"
								>{{ msg['username'] }}</span
							>
							<span class="timestamp"
								>{{ msg['sent_at'][:16] }}</span
							>
						</div>
						{% if not msg['deleted'] %}
						<form
							action="/admin/chats/{{ school }}/{{ msg['id'] }}/delete"
							method="POST"
							style="display: inline;">
							<button class="delete-btn" type="submit">
								Löschen
							</button>
						</form>
						{% else %}
						<form
							action="/admin/chats/{{ school }}/{{ msg['id'] }}/restore"
							method="POST"
							style="display: inline;">
							<button class="restore-btn" type="submit">
								Wiederherstellen
							</button>
						</form>
						{% endif %}
					</div>
					<div>{{ msg['message'] }}</div>
				</div>
				{% endfor %}
			</div>
		</div>

		<script>
			let currentStatus = { frozen: false, active: false };

			async function loadSanctionStatus() {
			    try {
			        const response = await fetch(`/admin/chats/{{ school }}/sanction_status`);
			        currentStatus = await response.json();
			        updateStatusDisplay();
			        document.getElementById('sanctionModal').style.display = 'block';
			    } catch (e) {
			        document.getElementById('sanctionStatus').innerHTML = 'Fehler beim Laden';
			    }
			}

			function updateStatusDisplay() {
			    const statusDiv = document.getElementById('sanctionStatus');
			    const btn = document.getElementById('freezeBtn');

			    if (currentStatus.active) {
			        statusDiv.innerHTML = `
			            <strong>Aktiv:</strong> ${currentStatus.frozen ? 'Eingefroren' : 'Normal'}<br>
			        `;
			        btn.textContent = currentStatus.frozen ? 'Chat auftauen' : 'Chat einfrieren';
			        btn.style.background = currentStatus.frozen ? '#10b981' : '#ef4444';
			    } else {
			        statusDiv.innerHTML = '<strong>Inaktiv</strong> - Keine Sanktionen';
			        btn.textContent = 'Chat einfrieren';
			        btn.style.background = '#ef4444';
			    }
			}

			async function toggleFreeze() {
			    const newFrozen = !currentStatus.frozen;
			    await fetch(`/admin/chats/{{ school }}/toggle_sanction`, {
			        method: 'POST',
			        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
			        body: `frozen=${newFrozen}`
			    });

			    currentStatus.frozen = newFrozen;
			    currentStatus.active = true;
			    updateStatusDisplay();
			}

			function closeSanctionModal() {
			    document.getElementById('sanctionModal').style.display = 'none';
			}

			function setTemplate(type, firstQuestion, double = false, secondQuestion = "") {
			    const input = document.getElementById('systemMessage');
			    const user = prompt(`${firstQuestion} eingeben:`);
			    if (user === null) return;

			    let secondAnswer = "";
			    if (double == true) {
			        secondAnswer = prompt(`${secondQuestion} eingeben:`);
			    }

			    if (type === 'warn') {
			        input.value = `Verwarnung für ${user} wegen ${secondAnswer}`;
			    } else if (type === 'ban') {
			        input.value = `Der Benutzer ${user} wurde von der Chat-Funktion ausgeschlossen`;
			    } else if (type === 'unban') {
			        input.value = `Der Benutzer ${user} wurde für die Chat-Funktion freigegeben`;
			    } else if (type === 'sanction') {
			        input.value = `Der Chat wurde sanktioniert: ${user == "j" ? "eingefroren": "aufgetaut"}`;
			    }
			    input.focus();
			    input.select();
			}

			function clearMessage() {
			    document.getElementById('systemMessage').value = '';
			}

			function connectToWS() {
			    const ws = new WebSocket(`ws://217.154.161.106:8000/ws/{{ school }}?token={{ apitoken }}`);

			    ws.onopen = () => {
			        console.log('Connected to chat!');
			    };

			    ws.onclose = (event) => {
			        console.log('Connection lost:', event.code, event.reason);
			    };

			    ws.onerror = (error) => {
			        console.error('WS error:', error);
			    };

			    ws.onmessage = (event) => {
			        window.location.reload();
			    };
			}

			connectToWS();
		</script>
	</body>
</html>
